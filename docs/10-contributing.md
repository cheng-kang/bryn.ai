## 10 — Contributing

Guidelines for contributing to Bryn AI development.

---

## Repository layout

### Top-level directories

- **public/**: Extension manifest and static assets (icons).
- **src/**: All source code (TypeScript, React, TSX).
- **docs/**: Documentation (this file and others).
- **dist/**: Build output (generated by Vite, load this in Chrome).
- **node_modules/**: Dependencies (generated by npm).

### Source structure (`src/`)

- **background/**: Service worker (background.js entry point).

  - `service-worker.ts`: Main background script. Handles messages, initializes AI, manages queue.

- **content-scripts/**: Injected into web pages.

  - `page-tracker.ts`: Collects page data and interactions.

- **core/**: Core business logic (AI, queue, storage, intent matching).

  - `ai-pipeline.ts`: Chrome AI API wrapper.
  - `intent-engine.ts`: Intent matching and lifecycle.
  - `processing-queue.ts`: Async task scheduler.
  - `storage-manager.ts`: IndexedDB abstraction.
  - `semantic-similarity.ts`: Hybrid embeddings and similarity.
  - `knowledge-graph.ts`: User knowledge model.
  - `merge-coordinator.ts`: Intent merge logic.
  - `completion-detector.ts`: Milestone and completion detection.

- **services/**: Higher-level services.

  - `nudge-generator.ts`: Proactive suggestion engine.
  - `ai-generator.ts`: AI-driven insight generation.
  - `activity-summarizer.ts`: Recent activity summaries.

- **sidepanel/**: React UI (main app, views, components, hooks).

  - `App.tsx`: Root component, routing, view stack.
  - `views/`: Full-screen views (Main Dashboard, Intent Detail, Task Queue, etc.).
  - `components/`: Reusable UI components (Intent Card, Page Card, Live Status, etc.).
  - `hooks/`: React hooks for state management and real-time updates.
  - `utils/`: Utilities (chrome message helpers, test scenarios, test executor).

- **components/ui/**: shadcn/ui components (Button, Card, Dialog, etc.).

- **types/**: TypeScript type definitions.

  - `intent.ts`, `page.ts`, `nudge.ts`, `task.ts`, `storage.ts`, etc.

- **styles/**: Global CSS (Tailwind).

---

## Scripts

### Install dependencies

```bash
npm install
```

Installs all packages listed in `package.json`.

### Build for production

```bash
npm run build
```

**What it does**:

1. Runs TypeScript compiler (`tsc`) to check types.
2. Runs Vite build to bundle the extension.
3. Outputs to `dist/` folder.

**When to use**: After making code changes. Load `dist/` in Chrome.

### Development server (UI only)

```bash
npm run dev
```

**What it does**: Starts Vite dev server with hot module replacement at `http://localhost:5173`.

**When to use**: For rapid UI iteration. Changes to React components auto-reload.

**Limitation**: Background logic (service worker, content script) doesn't hot reload. You still need to rebuild and reload the extension for those changes.

### Preview build

```bash
npm run preview
```

**What it does**: Serves the production build locally for testing.

**When to use**: Test the production build before distributing.

### Lint code

```bash
npm run lint
```

**What it does**: Runs ESLint on all TypeScript/TSX files.

**When to use**: Before committing. Fix linting errors to maintain code quality.

---

## Code style

### TypeScript

- **Explicit types**: Add return types to exported functions. Infer types for local variables when obvious.
- **Avoid `any`**: Use `unknown` or specific types. Add `// @ts-expect-error` with a comment if truly necessary.
- **Named exports**: Prefer `export function foo()` over `export default foo`.

### React

- **Function components**: Use function components, not class components.
- **Hooks**: Use hooks (`useState`, `useEffect`, etc.) for state and side effects.
- **Props interface**: Define an interface for component props.
- **Memoization**: Use `React.memo`, `useMemo`, `useCallback` for expensive renders (but don't over-optimize).

### File naming

- **Components**: PascalCase (e.g., `IntentCard.tsx`).
- **Utilities**: kebab-case (e.g., `chrome-message.ts`).
- **Types**: kebab-case (e.g., `intent.ts`).

### Comments

- **Why, not what**: Explain non-obvious decisions, caveats, or trade-offs. Don't comment obvious code.
- **TODO comments**: Mark unfinished work with `// TODO: <description>`.
- **JSDoc**: Use JSDoc for complex functions (optional, but helpful for public APIs).

**Good comment example**:

```typescript
// Use exponential backoff to prevent retry storms if AI is temporarily unavailable
const delay = 1000 * Math.pow(2, retryCount);
```

**Bad comment example**:

```typescript
// Increment retry count
retryCount++;
```

### Formatting

- **Prettier** (not configured yet): Consider adding Prettier for consistent formatting.
- **Indentation**: 2 spaces (enforced by ESLint).
- **Line length**: 80–100 chars (soft limit, not enforced).

---

## Development workflow

### Making a change

1. **Create a feature branch** (optional, for Git workflow):

   ```bash
   git checkout -b feature/your-feature-name
   ```

2. **Edit source files** in `src/`.

3. **Rebuild the extension**:

   ```bash
   npm run build
   ```

4. **Reload the extension** in Chrome:

   - Go to `chrome://extensions`.
   - Click the reload icon for Bryn AI.

5. **Test the change**:

   - Open the side panel and verify behavior.
   - Use Scenario Runner or manual testing.

6. **Lint and fix errors**:

   ```bash
   npm run lint
   ```

7. **Commit the change** (if using Git):
   ```bash
   git add .
   git commit -m "Add feature: <description>"
   ```

### Testing changes

- **Automated**: Use Scenario Runner in Developer Hub.
- **Manual**: Visit web pages, create intents, trigger nudges.
- **Edge cases**: Test error pages, SPAs, CSP-blocked sites, long content, sparse content.

### Debugging

- **Service worker logs**: `chrome://extensions` → Bryn AI → service worker → Console.
- **Side panel logs**: Open side panel → Inspect (right-click → Inspect) → Console.
- **Content script logs**: Open a web page → F12 → Console.
- **Task details**: Open Task Queue → click a task → view prompt, response, errors.

---

## Pull request guidelines

### Before submitting a PR

1. **Rebuild and test**:

   - Run `npm run build`.
   - Load the extension and test thoroughly.
   - Run Scenario Runner to validate core flows.

2. **Lint and fix**:

   - Run `npm run lint`.
   - Fix all errors and warnings.

3. **Write a clear description**:

   - **What**: What does this PR change?
   - **Why**: Why is this change necessary?
   - **How**: How does it work (if non-obvious)?
   - **Testing**: How did you test it?

4. **Add screenshots/GIFs** (for UI changes):

   - Show before/after.
   - Demonstrate the new behavior.

5. **Note breaking changes** (if any):
   - Changes to storage schema (requires data migration).
   - Changes to manifest permissions (requires user consent).
   - Changes to AI prompts (might affect existing intents).

### PR scope

- **Keep PRs small**: One feature or fix per PR. Large PRs are hard to review.
- **Refactoring**: Separate refactoring from feature PRs (easier to review).
- **Documentation**: Update docs if you change user-facing behavior or APIs.

### Code review

- **Address feedback**: Respond to review comments and make requested changes.
- **Explain decisions**: If you disagree with a suggestion, explain why.
- **Iterate quickly**: Don't let PRs stagnate. Push fixes promptly.

---

## Development tips

### Working with the queue

- **Use Task Queue View** to monitor task execution.
- **Add debug logging** to tasks (wrap in `console.log` with task ID).
- **Test retry logic** by simulating failures (e.g., throw an error in AI pipeline).

### Working with AI

- **Check AI availability** before testing AI tasks (`chrome://components`).
- **Use structured prompts**: Keep prompts concise and clear. AI quality degrades with long prompts.
- **Test fallbacks**: Ensure heuristic fallbacks work when AI is unavailable.

### Working with storage

- **Inspect IndexedDB**: F12 → Application → IndexedDB → BrynAI_DB.
- **Test deduplication**: Visit the same page twice quickly and confirm only one record is saved.
- **Test reactivity**: Make a storage change and confirm the UI updates.

### Working with UI

- **Use React DevTools**: Install React DevTools extension to inspect component state.
- **Test view transitions**: Navigate between views and confirm the view stack works.
- **Test live updates**: Open Task Queue while running a scenario and watch tasks update in real-time.

---

## Common pitfalls

### 1. Forgetting to rebuild

**Problem**: You edit `src/` but forget to run `npm run build`. The extension still runs the old code.

**Solution**: Always rebuild after changes. Consider setting up a file watcher (not included yet).

### 2. Service worker termination

**Problem**: Service workers can be terminated by Chrome at any time. Global state is lost.

**Solution**: Persist critical state to IndexedDB (queue already does this). Don't rely on in-memory state.

### 3. Async race conditions

**Problem**: Two tasks try to update the same intent simultaneously, causing a race condition.

**Solution**: Use atomic operations in StorageManager. Serialize critical tasks (P1–P3 limited to 1 concurrent).

### 4. Large prompts

**Problem**: Sending 50KB of page content to the AI times out or fails.

**Solution**: Truncate content to 10–20KB. Summarize before sending if necessary.

### 5. Hardcoded IDs

**Problem**: Test code uses hardcoded task/intent IDs that break when data is cleared.

**Solution**: Generate IDs dynamically. Use task signatures (type + entity) for deduplication, not raw IDs.

---

## Testing best practices

### Unit testing (not implemented yet)

Consider adding:

- **Jest** or **Vitest** for unit tests.
- **Testing Library** for React component tests.
- **Mock** AI API responses to test logic without running real AI.

### Integration testing

Use Scenario Runner:

- **Cover happy paths**: Fragmented Research, Smart Completion.
- **Cover failure modes**: Graceful Failure, AI Unavailable.
- **Cover edge cases**: Empty pages, long content, sparse content.

### Manual testing

- **Test on real websites**: News sites, blogs, e-commerce, forums.
- **Test cross-domain research**: Visit related pages on different domains.
- **Test long-term flows**: Use Bryn for a week and observe dormant intents, merge suggestions.

---

## Deployment (future)

Not yet implemented:

- **Chrome Web Store**: Publish the extension.
- **Auto-updates**: Users receive updates automatically.
- **Versioning**: Follow semantic versioning (MAJOR.MINOR.PATCH).
- **Changelog**: Document changes for each release.

---

## Resources

### Chrome extension docs

- [Manifest V3](https://developer.chrome.com/docs/extensions/mv3/intro/)
- [Service workers](https://developer.chrome.com/docs/extensions/mv3/service_workers/)
- [Content scripts](https://developer.chrome.com/docs/extensions/mv3/content_scripts/)
- [Side panel](https://developer.chrome.com/docs/extensions/reference/sidePanel/)

### Chrome built-in AI

- [Prompt API](https://developer.chrome.com/docs/ai/built-in)
- [Summarization API](https://developer.chrome.com/docs/ai/summarizer-api)
- [Language Detection API](https://developer.chrome.com/docs/ai/language-detector-api)

### React

- [React docs](https://react.dev/)
- [React hooks](https://react.dev/reference/react)

### Tailwind CSS

- [Tailwind docs](https://tailwindcss.com/docs)

### shadcn/ui

- [Components](https://ui.shadcn.com/docs/components)

---

## Contact

For questions or discussions:

- Check the repository's issue tracker.
- Review existing docs in `docs/`.
- Inspect the source code (it's designed to be readable).

**Code reference**: Full source in `src/` directory. Start with `src/background/service-worker.ts` (entry point) and `src/sidepanel/App.tsx` (UI entry point).
