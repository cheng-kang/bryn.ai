## 05 — Data Model

All data is stored locally in **IndexedDB** via the Storage Manager. Nothing syncs to the cloud. Data is cleared when you uninstall the extension.

---

## Object stores

### 1. pages

**Purpose**: Every visited page with metadata, content, interactions, and intent assignments.

**Key path**: `id` (generated UUID)

**Indexes**:

- `url`: Fast lookup by URL.
- `timestamp`: Query recent pages chronologically.
- `intentAssignments.primary.intentId`: Find all pages for a given intent.

**Schema highlights**:

- `url`, `title`, `timestamp`: Basic metadata.
- `content`, `contentSummary`: Extracted text and AI-generated summary.
- `contentSize`: Size in bytes for filtering long pages.
- `metadata`: Domain, language, referrer, Open Graph tags, structural counts (headings, links), page type signals (404, error).
- `interactions`: Scroll depth, dwell time, text selections, focus time → used for engagement score and behavior classification.
- `semanticFeatures`: AI-extracted concepts, entities (people, products, organizations), intent signals.
- `embedding`: 256-dim hybrid vector for similarity matching.
- `intentAssignments`: Primary intent ID, confidence, alternatives.

---

### 2. intents

**Purpose**: Clustered groups of related pages with AI-generated labels, summaries, and insights.

**Key path**: `id` (generated UUID)

**Indexes**:

- `status`: Filter by Active, Dormant, Completed.
- `lastUpdated`: Query recently updated intents.
- `firstSeen`: Query intents by creation date.

**Schema highlights**:

- `status`: "active" | "dormant" | "completed".
- `label`, `goal`, `summary`, `insights`, `nextSteps`: AI-generated analysis (refreshed as pages are added).
- `pageCount`, `firstSeen`, `lastUpdated`: Basic stats.
- `aggregatedSignals`: Keywords, entities, domains, behavioral patterns across all pages.
- `userFeedback`: User edits, discarded flag, manual status overrides.

---

### 3. nudges

**Purpose**: Proactive suggestions and actions generated by the Nudge Generator.

**Key path**: `id` (generated UUID)

**Indexes**:

- `intentId`: Find all nudges for a given intent.
- `status`: Filter by New, Delivered, Snoozed, ActedOn, Dismissed.
- `priority`: Order by importance.

**Schema highlights**:

- `type`: "resume" | "knowledge_gap" | "milestone" | "merge_suggestion" | "dormant_reminder".
- `message`: Human-readable suggestion (e.g., "Ready to pick up your React hooks reading?").
- `actions`: Array of CTAs (e.g., `[{ label: "Resume", url: "..." }]`).
- `status`: Lifecycle tracking.
- `priority`: Higher values = more important.
- `generatedAt`, `deliveredAt`, `actedOnAt`: Timestamps.

---

### 4. processingQueue

**Purpose**: Persistent queue state for background tasks. Survives extension reloads.

**Key path**: `id` (generated UUID)

**Indexes**:

- `status`: Filter by "queued" | "processing" | "completed" | "failed".
- `priority`: Order by priority (lower number = higher priority).
- `createdAt`: Queue order within same priority.

**Schema highlights**:

- `type`: Task type (e.g., "semantic_extraction", "intent_matching", "generate_intent_label").
- `pageId`, `intentId`: Associated entities.
- `priority`: 1–30 (1 = highest).
- `status`, `retryCount`, `error`: Lifecycle and failure tracking.
- `dependencies`: Array of task IDs that must complete first.
- `attempts`: History of retry attempts with timestamps and errors.
- `aiExecution`: Prompt, response, API used (LanguageModel, Summarizer, etc.), parameters.
- `structuredInput`, `structuredOutput`: Task-specific data.
- `durationMs`: Execution time for performance tracking.

---

### 5. relationships

**Purpose**: Explicit links between intents (e.g., "Intent A relates to Intent B with 0.8 similarity").

**Key path**: `id` (generated UUID)

**Indexes**:

- `fromIntentId`: Find all relationships from a given intent.
- `toIntentId`: Find all relationships to a given intent.

**Schema highlights**:

- `fromIntentId`, `toIntentId`: The two intents.
- `type`: "similar" | "prerequisite" | "continuation".
- `strength`: 0.0–1.0 similarity score.
- `detectedAt`: Timestamp.

---

### 6. settings

**Purpose**: User preferences and feature flags.

**Key path**: `key` (string)

**Schema**: Key-value pairs. Examples: `{ key: "developerMode", value: true }`.

---

### 7. knowledgeGraph

**Purpose**: Persistent model of user's interests, knowledge levels, and followed entities.

**Key path**: `version` (always 1, single-record store)

**Schema highlights**:

- `interests`: Map of topics to interest scores.
- `knowledge`: Map of topics to knowledge levels (learning, familiar, mastered).
- `entities`: People, products, creators the user follows (e.g., YouTuber: MKBHD).
- `lastUpdated`: Timestamp.

---

### 8. activitySummaries

**Purpose**: Cached AI-generated summaries of recent activity for the main dashboard.

**Key path**: `id` (generated UUID)

**Indexes**:

- `generatedAt`: Query by freshness.

**Schema highlights**:

- `timeRange`: "today" | "this_week" | "this_month".
- `summary`: Human-readable text (e.g., "This morning you were catching up on Project Phoenix docs and researching new headphones.").
- `generatedAt`: Timestamp.
- `intentIds`: Array of intents included in the summary.

---

## Duplicate detection

**Problem**: SPAs and fast navigation can trigger multiple page tracker events for the same page.

**Solution**: When saving a page, the Storage Manager checks:

1. Does a page with this `id` already exist? → Merge interactions and metadata.
2. Does a page with this `url` exist within the last 30 seconds? → Merge instead of creating a duplicate.

**Why 30 seconds?** Strikes a balance between catching duplicates and allowing re-visits.

**Code reference**: `src/core/storage-manager.ts` lines 106–135 (savePage method).

---

## UI reactivity

**How it works**:

1. Storage Manager emits events when data changes:
   - `page-added`, `page-updated`: UI renders page card or updates it.
   - `intent-updated`: UI refreshes intent label/summary.
   - `nudge-added`: UI shows new suggested action.
2. React components subscribe to these events via hooks (`use-realtime-updates.ts`).
3. Background enrichment updates the same records; UI auto-refreshes to show the latest data.

**Why events instead of polling?** Events are instant and efficient. Polling would waste CPU and introduce lag.

---

## Storage usage

**Typical sizes**:

- **Page**: ~10KB (compressed content + metadata).
- **Intent**: ~5KB (labels, summaries, aggregated signals).
- **Queue task**: ~2KB (prompt + response can be large).

**Example**: 1000 pages + 50 intents + 100 tasks ≈ 10MB + 250KB + 200KB ≈ **10.5MB total**.

**Quota**: Chrome's `unlimitedStorage` permission removes the default 10MB limit. Bryn can store as much data as disk space allows.

**Monitoring**: The Settings view displays total storage usage (e.g., "Storage Used: 15.2 MB").

---

## Data lifecycle

### Page

1. **Created**: When content script sends data to background.
2. **Enriched**: Background tasks add `semanticFeatures`, `embedding`, `intentAssignments`, `contentSummary`.
3. **Updated**: If user re-visits, interactions are merged.
4. **Deleted**: Manually (via UI) or when intent is deleted.

### Intent

1. **Created**: When a page doesn't match any existing intent.
2. **Enriched**: Background tasks generate `label`, `goal`, `summary`, `insights`, `nextSteps`.
3. **Refreshed**: When new pages are added, tasks re-run at lower priority.
4. **Transitioned**: Active → Dormant (7+ days no activity) or Active → Completed (milestone detected or manual).
5. **Deleted**: Manually (via UI).

### Nudge

1. **Created**: When Nudge Generator detects a trigger (dormant intent, knowledge gap, etc.).
2. **Delivered**: When shown in the UI.
3. **Acted On**: When user clicks a CTA.
4. **Dismissed**: When user dismisses or snoozes.
5. **Deleted**: After 30 days or when associated intent is deleted.

### Queue Task

1. **Created**: When page is saved or intent is updated.
2. **Queued**: Added to priority queue.
3. **Processing**: Picked up by queue processor.
4. **Completed**: Result saved to page/intent.
5. **Failed**: Error logged, retry scheduled with backoff.
6. **Deleted**: After 7 days (to keep queue history lean).

---

## Export format

The "Export All Data" button in Settings generates a JSON file with all stores:

```json
{
  "version": "1.0",
  "exportedAt": 1234567890,
  "pages": [
    /* all page records */
  ],
  "intents": [
    /* all intent records */
  ],
  "nudges": [
    /* all nudge records */
  ],
  "processingQueue": [
    /* all task records */
  ],
  "relationships": [
    /* all relationship records */
  ],
  "settings": [
    /* all settings */
  ],
  "knowledgeGraph": {
    /* knowledge graph record */
  },
  "activitySummaries": [
    /* all summaries */
  ]
}
```

**Use cases**: Debugging, data portability, archiving.
